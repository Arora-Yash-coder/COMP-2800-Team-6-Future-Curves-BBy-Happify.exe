<!DOCTYPE html>
<html lang="en">

<head>
  <!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script> -->
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  <link rel="stylesheet" type="text/css" href="/static/css/user_profile.css">
  <link rel="stylesheet" type="text/css" href="/static/css/navbar.css">
  
</head>

<body>
    <header id="head">
  <%- navbar %></header>
  <h1>User Profile</h1>

  <img id="avatar" class="avatar" src="/img/avatar.png">
  <form action="/upload_avatar" enctype="multipart/form-data" method="post">
    <input type="file" class="avatar" id="upload" name="upload">
    <input type="submit" id="submit" value="Upload file">

  </form>


  <div id="container">
    <form id="userForm" action="/api/users/register" method="post">
      <div id="username">Username</div>
      <input id="usernameinput" rows="1" placeholder='Username' name="username" ;></input>
      <div id="password">Password

      </div>
      <input id="passwordinput" rows="1" type="password" placeholder='Password' name="password" min="6" maxlength="16"></input>
      <div id="firstname">First Name

      </div>
      <input id="firstnameinput" rows="1" placeholder='Firstname' name="firstname"></input>
      <div id="lastname">Last Name

      </div>
      <input id="lastnameinput" rows="1" placeholder='Lastname' name="lastname"></input>
      <div id="email">Email

      </div>
      <input id="emailinput" rows="1" placeholder='Email' type="email" name="email"></input>
      <div id="phoneno">Phone Number

      </div>
      <input id="phonenoinput" rows="1" placeholder='Phone Number, starting with 1-' name="phoneno"></input>
      <br>
    </form>
  </div>
  <div id="mycoupons">

    <h2>My coupons</h2>
  </div>

  <button type="button" onclick="save()" id="save">Save</button>
  <button id="logout">log out!</button>
  <br>
  <!--
    <div id="submit">
    <a href="#" class="square_btn">Yes</a></div>
-->
  <%- footer %>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
  <script>
    //=====================upload==========avatar====================
    $(document).ready(function () {



      $(".avatar").on("click", () => {
        document.getElementById("upload").click();

      })
      //local Storage reads the attribute "picture" to the document.

      var pictureSrc = window.localStorage.getItem("picture");
      if (pictureSrc) {
        $('#avatar').attr('src', pictureSrc);
      }else{
        $('#avatar').attr('src', "/img/avatar.png");
      }

      //regex that would allow the browse function to work.
      $(document).on('change', '.btn-file :file', function () {
        var input = $(this),
          label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
        input.trigger('fileselect', [label]);
      });

      $('.btn-file :file').on('fileselect', function (event, label) {

        var input = $(this).parents('.input-group').find(':text'),
          log = label;

        if (input.length) {
          input.val(log);
        } else {
          if (log) alert(log);
        }

      });






      //the function reads the URL to the picture.
      function readURL(input) {


        var reader = new FileReader();

        reader.onload = function (e) {
          pictureSrc = e.target.result;
          $('#avatar').attr('src', pictureSrc);
          /*this line of code is crucial, if it is put outside
          of the the function(e){} callback, then the memory function
          would not work*/
          localStorage.setItem("picture", pictureSrc);

        }
        // localStorage.setItem("picture", pictureSrc);
        reader.readAsDataURL(input.files[0]);
      }

      //After some picture is upload, the page reads the new URL
      $(".avatar").change(function (e) {
        $("#submit").click();
        e.preventDefault();
        console.log(this.files[0]);
        console.log(readURL(this));
      });
    });
    //       reader.readAsDataURL(input.files[0]);





    //=====================upload==========avatar====================


    //======================UPDATE======INFO

    $("#save").click(() => {
      let usernameinput = $("#usernameinput").val()
      let passwordinput = $("#passwordinput").val()
      let firstnameinput = $("#firstnameinput").val()
      let lastnameinput = $("#lastnameinput").val()
      let emailinput = $("#emailinput").val()
      let phonenoinput = $("#phonenoinput").val()

      let data = {
        username: usernameinput,
        password: passwordinput,
        email: emailinput,
        phoneno: phonenoinput,
        firstname: firstnameinput,
        lastname: lastnameinput
      }
      console.log(data)

      $.ajax({
        type: "post",
        url: "/user_profile/setProfile",
        data: data,
        dataType: "text",
        success: function (response) {
          console.log(response)
          setTimeout(() => {
            window.location.href = "/homepage"
          }, 300);
        }
      });
    })











    $.ajax({
      url: "/user_profile/getProfile",
      dataType: "json",
      type: "GET",
      success: function (data) {
        let usernameinput = $("#usernameinput").val()
      let passwordinput = $("#passwordinput").val()
      let firstnameinput = $("#firstnameinput").val()
      let lastnameinput = $("#lastnameinput").val()
      let emailinput = $("#emailinput").val()
      let phonenoinput = $("#phonenoinput").val()




        //USERNAME
        var div_usrname = $("#username");
        var text_usernameinput = $("#usernameinput");

        let username = "" + data.result[0].username;
        $("#usernameinput").val(username)

        //PASSWORD
        var div_password = $("#password");

        var text_passwordinput = $("#passwordinput");
        let htmlStr2 = "";
        let password = "" + data.result[0].password;
        $("#passwordinput").val(password)

        //FIRSTNAME
        var div_firstname = $("#firstname");
        var text_firstnameinput = $("#firstnameinput");

        let firstname = "" + data.result[0].firstname;
        $("#firstnameinput").val(firstname)

        //LAST NAME
        var div_lastname = $("#lastname");

        var text_lastnameinput = $("#lastnameinput");
        let htmlStr5 = "";
        let lastname = "" + data.result[0].lastname;
        $("#lastnameinput").val(lastname)

        //EMAIL
        var div_email = $("#email");
        var text_emailinput = $("#emailinput");

        let htmlStr3 = "";
        let email = "" + data.result[0].email;
        $("#emailinput").val(email)

        //PHONE
        var div_phoneno = $("#phoneno");
        var text_phonenoinput = $("#phonenoinput");


        let htmlStr6 = "";
        let phoneno = "" + data.result[0].phoneno;
        $("#phonenoinput").val(phoneno)

      },
      error: function (jqXHR, textStatus, errorThrown) {
        $("#p1").text(textStatus + " " + errorThrown
          + jqXHR.responseText);
      }
    });

    $("#mycoupons").click(() => {
      window.location.href = "/my_coupons"
    })

    $("#logout").click(() => {
      window.location.href = "/logout";
    })
  </script>
  <script src='/static/js/navbar_top.js'></script>
</body>

</html>