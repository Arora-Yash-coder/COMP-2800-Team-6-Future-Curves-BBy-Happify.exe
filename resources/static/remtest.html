<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
</head>
<body>
    <!-- <button onclick="subscribe()">subscribe</button> -->
    <button onclick="newAPIkey()">subscribe</button>
    <button onclick="submit()">push</button>
	
    <script>
        let publicKey = null







        
        addEventListener('load',async()=>{
            let sw = await navigator.serviceWorker.register('/sw.js')
            console.log(sw)
        })





        function newAPIkey(){
            $.ajax({
                type: "get",
                url: "/subscribe",
                dataType: "json",
                success: function (response) {
                    publicKey = response.publicKey
                    console.log(publicKey)
                    
                }
            });
        }

       
        async function subscribe(){
            let sw = await navigator.serviceWorker.ready;
            //pushed to the browser
            let push = await sw.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey:publicKey
            })
          
            console.log(JSON.stringify(push))
            return JSON.stringify(push);
            
           
        }
        //send stringified json to /post
        async function submit(){
            console.log("submit")
            subscribe().then((push)=>{
            console.log("submit")
            console.log(push)
            $.ajax({
               type: "post",
               url: "/push",
               data: {push},
               dataType: "text",
               success: function (response) {
                   alert(response)
               }
           });
        })
        }

       


        
        // function submit(){
        //    console.log("sub_info")
        //    console.log(sub_info)
        //    $.ajax({
        //        type: "post",
        //        url: "/post",
        //        data: {sub_info},
        //        dataType: "dataType",
        //        success: function (response) {
        //            alert(response)
        //        }
        //    });
        // }

    </script>
</body>
</html>